<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Web Speech API est native, pas besoin de script externe -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur Audio</title>
    
    <!-- React UMD -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .drop-zone {
            border: 2px dashed #6366f1;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .drop-zone.drag-over {
            border-color: #4f46e5;
            background-color: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .record-button {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #ef4444;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .record-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }

        .record-button.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .metric-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        .metric-card:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const BASE_URL = 'http://192.168.0.157:5000';

// Fonction pour afficher le dashboard des audios analysés
const fetchAnalyzedAudios = async () => {
    try {
        const response = await fetch(`${BASE_URL}/get_analyzed_files`);
        if (!response.ok) {
            throw new Error('Erreur lors de la récupération des fichiers analysés');
        }
        return await response.json();
    } catch (error) {
        console.error('Erreur:', error);
        return [];
    }
};

// Composant Dashboard
function Dashboard() {
    const [analyzedFiles, setAnalyzedFiles] = React.useState([]);
    
    React.useEffect(() => {
        const loadFiles = async () => {
            const files = await fetchAnalyzedAudios();
            setAnalyzedFiles(files);
        };
        loadFiles();
    }, []);
    
    return (
        <div className="mt-12 container mx-auto px-4 py-8 max-w-6xl">
            <h2 className="text-3xl font-bold mb-6 text-indigo-600">Historique des analyses</h2>
            {analyzedFiles.length === 0 ? (
                <p className="text-gray-500 text-center">Aucun fichier audio analysé</p>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {analyzedFiles.map((file, index) => (
                        <div key={index} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                            <h3 className="font-semibold text-lg text-indigo-800 mb-2">{file.filename}</h3>
                            <p className="text-gray-600 mb-4">Analysé le: {new Date(file.timestamp).toLocaleString()}</p>
                            <div className="text-3xl font-bold text-indigo-600 mb-2">{file.score}/10</div>
                            <button 
                                className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                onClick={() => window.location.href = `${BASE_URL}/results/${file.result_file}`}
                            >
                                Voir les détails
                            </button>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}



        function App() {
            const [isRecording, setIsRecording] = React.useState(false);
            const [mediaRecorder, setMediaRecorder] = React.useState(null);
            const [audioChunks, setAudioChunks] = React.useState([]);
            const [file, setFile] = React.useState(null);
            const [isDragOver, setIsDragOver] = React.useState(false);
            const [isLoading, setIsLoading] = React.useState(false);
            const [results, setResults] = React.useState(null);
            const [error, setError] = React.useState(null);

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                
                const droppedFile = e.dataTransfer.files[0];
                if (droppedFile && droppedFile.type.startsWith('audio/')) {
                    setFile(droppedFile);
                    analyzeFile(droppedFile);
                } else {
                    setError('Veuillez déposer un fichier audio valide');
                }
            };

            const handleFileSelect = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile) {
                    setFile(selectedFile);
                    analyzeFile(selectedFile);
                }
            };

            const analyzeFile = async (audioFile) => {
                setIsLoading(true);
                setError(null);
                setResults(null);

                const formData = new FormData();
                formData.append('file', audioFile);

                try {
                    const response = await fetch(`${BASE_URL}/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Erreur lors de l\'analyse');
                    }

                    const data = await response.json();
                    setResults(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            const startRecording = async () => {
                try {
                    // Check if running in a secure context
                    if (!window.isSecureContext) {
                        throw new Error('L\'accès au microphone nécessite un contexte sécurisé (HTTPS ou localhost)');
                    }

                    // Check for MediaDevices API support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('L\'API MediaDevices n\'est pas supportée par votre navigateur');
                    }

                    console.log('Requesting microphone access...');
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('Microphone access granted:', stream.getAudioTracks()[0].label);

                    const recorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm'
                    });
                    setMediaRecorder(recorder);
                    
                    recorder.ondataavailable = (e) => {
                        console.log('Data available:', e.data.size, 'bytes');
                        setAudioChunks(chunks => [...chunks, e.data]);
                    };

                    recorder.onstop = async () => {
                        console.log('Recording stopped');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        console.log('Created blob:', audioBlob.size, 'bytes');
                        await analyzeFile(audioBlob);
                        setAudioChunks([]);
                        
                        // Stop all tracks in the stream to release the microphone
                        stream.getTracks().forEach(track => {
                            track.stop();
                            console.log('Track stopped:', track.label);
                        });
                    };

                    recorder.start(1000); // Collect data every second
                    console.log('Recording started');
                    setIsRecording(true);
                } catch (error) {
                    // Log detailed error information
                    console.error('Error accessing microphone:', {
                        name: error.name,
                        message: error.message,
                        stack: error.stack,
                        error: error
                    });

                    let errorMessage = 'Erreur d\'accès au microphone: ';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage += 'Accès refusé. Veuillez autoriser l\'accès au microphone dans les paramètres de votre navigateur:\n' +
                            '1. Cliquez sur l\'icône de cadenas/info à gauche de la barre d\'adresse\n' +
                            '2. Trouvez les paramètres du microphone\n' +
                            '3. Sélectionnez "Autoriser"\n\n' +
                            'Si le problème persiste, essayez de:\n' +
                            '- Rafraîchir la page\n' +
                            '- Vérifier que d\'autres applications n\'utilisent pas le microphone\n' +
                            '- Redémarrer le navigateur';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'Aucun microphone détecté. Veuillez:\n' +
                            '1. Vérifier que votre microphone est bien connecté\n' +
                            '2. Vérifier qu\'il est sélectionné comme périphérique par défaut\n' +
                            '3. Réessayer après avoir connecté un microphone';
                    } else if (error.name === 'NotReadableError' || error.name === 'AbortError') {
                        errorMessage += 'Le microphone est peut-être utilisé par une autre application.\n' +
                            'Veuillez fermer les autres applications qui pourraient utiliser le microphone.';
                    } else if (!window.isSecureContext) {
                        errorMessage += 'L\'accès au microphone nécessite une connexion sécurisée (HTTPS).\n' +
                            'Veuillez utiliser HTTPS ou localhost.';
                    } else {
                        errorMessage += `${error.message}\n` +
                            'Type d\'erreur: ' + error.name;
                    }
                    
                    setError(errorMessage);
                    setIsRecording(false);
                }
            };

            const stopRecording = () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    setIsRecording(false);
                }
            };

            const readFeedback = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                window.speechSynthesis.speak(utterance);
            };

            const renderResults = () => {
                if (!results) return null;

                // Nettoyer la réponse JSON de l'API en enlevant les backticks et 'json'
                const cleanJsonStr = results.ai_response.replace(/```json\n|```/g, '');
                const aiResponse = JSON.parse(cleanJsonStr);
                const analysisData = results.analyse_result;
                readFeedback(aiResponse.feedback);

                return (
                    <div className="mt-8 bg-white p-8 rounded-xl shadow-xl">
                        <h2 className="text-3xl font-bold mb-6 text-indigo-600">Résultats de l'analyse</h2>
                        
                        <div className="mb-8 bg-indigo-50 p-6 rounded-lg">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-2xl font-semibold text-indigo-900">Évaluation IA</h3>
                                <button
                                    onClick={() => readFeedback(aiResponse.feedback)}
                                    className="px-4 py-2 hidden bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                >
                                    🔊 Écouter le feedback
                                </button>
                            </div>
                            <div className="text-4xl font-bold text-indigo-600 mb-4">{aiResponse.note}/10</div>
                            <p className="text-gray-700 text-lg leading-relaxed">{aiResponse.feedback}</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="metric-card">
                                <div className="font-medium text-gray-600">Hauteur moyenne</div>
                                <div className="text-2xl font-bold text-indigo-600">{analysisData.pitch_mean.toFixed(2)} Hz</div>
                            </div>
                            <div className="metric-card">
                                <div className="font-medium text-gray-600">Tempo</div>
                                <div className="text-2xl font-bold text-indigo-600">{analysisData.tempo[0].toFixed(0)} BPM</div>
                            </div>
                            <div className="metric-card">
                                <div className="font-medium text-gray-600">Score rythmique</div>
                                <div className="text-2xl font-bold text-indigo-600">{(analysisData.rhythm_score * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    <h1 className="text-4xl font-bold text-center mb-8 text-indigo-900">Analyseur de Performance Vocale</h1>
                    
                    <div className="flex justify-center mb-8">
                        <button
                            className={`record-button ${isRecording ? 'recording' : ''}`}
                            onClick={isRecording ? stopRecording : startRecording}
                        >
                            {isRecording ? (
                                <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12" />
                                </svg>
                            ) : (
                                <svg className="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="6" />
                                </svg>
                            )}
                        </button>
                    </div>
                    
                    <p className="text-center text-gray-600 mb-8">
                        {isRecording ? 'Cliquez pour arrêter l\'enregistrement' : 'Cliquez pour commencer l\'enregistrement'}
                    </p>
                    
                    <div
                        className={`drop-zone ${isDragOver ? 'drag-over' : ''} max-w-xl mx-auto`}
                        onDragOver={(e) => { e.preventDefault(); setIsDragOver(true); }}
                        onDragLeave={() => setIsDragOver(false)}
                        onDrop={handleDrop}
                    >
                        {isLoading ? (
                            <div className="flex flex-col items-center">
                                <svg className="loading w-12 h-12 text-blue-500" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p className="mt-4 text-gray-600">Analyse en cours...</p>
                            </div>
                        ) : (
                            <div className="p-6">
                                <input
                                    type="file"
                                    accept="audio/*"
                                    onChange={handleFileSelect}
                                    className="hidden"
                                    id="fileInput"
                                />
                                <label
                                    htmlFor="fileInput"
                                    className="cursor-pointer block text-center"
                                >
                                    <div className="text-lg mb-2">Déposez votre fichier audio ici</div>
                                    <div className="text-sm text-gray-500">ou cliquez pour sélectionner</div>
                                </label>
                            </div>
                        )}
                    </div>

                    {error && (
                        <div className="mt-4 p-4 bg-red-100 text-red-700 rounded-lg max-w-xl mx-auto">
                            {error.split('\n').map((line, i) => (
                                <p key={i} className="mb-2 last:mb-0">{line}</p>
                            ))}
                        </div>
                    )}

                    {renderResults()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>